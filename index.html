<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISSCC Country Share Analysis (2025 & 2026)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
    <div id="root" class="p-6">
        <div class="max-w-7xl mx-auto">
            <header class="mb-8 text-center">
                <h1 class="text-4xl font-bold text-slate-800 mb-2">
                    ISSCC Country Share Analysis (2025 & 2026)
                </h1>
                <p class="text-slate-600">
                    Conference Papers by Country
                    <span id="subcommittee-name" class="ml-2 font-semibold text-blue-600"></span>
                </p>
                <div class="mt-4 flex justify-center">
                    <div class="w-full max-w-xs">
                        <label class="block text-sm font-medium text-slate-700 mb-2 text-left">
                            Dataset
                        </label>
                        <select id="dataset-select" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="2025">ISSCC 2025 Results</option>
                            <option value="2026">ISSCC 2026 Results</option>
                        </select>
                    </div>
                </div>
            </header>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            View
                        </label>
                        <select id="view-select" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </select>
                    </div>

                    <div class="flex-1">
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            Author Type
                        </label>
                        <select id="author-select" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="first">First Author</option>
                            <option value="last">Last Author</option>
                        </select>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-xl font-semibold text-slate-800 mb-4 text-center">
                            Share Distribution
                        </h2>
                        <div class="flex justify-center">
                            <canvas id="pieChart" width="400" height="400"></canvas>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-xl font-semibold text-slate-800 mb-4 text-center">
                            Detailed Data
                        </h2>
                        <div class="overflow-y-auto max-h-[400px] border border-slate-200 rounded-lg">
                            <table class="w-full">
                                <thead class="bg-slate-100 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-slate-700">Rank</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-slate-700">Country</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-slate-700">Count</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold text-slate-700">Share (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="text-center text-sm text-slate-500 mt-8">
                <p>ISSCC 2025 & 2026 Country Share Analysis Dashboard</p>
            </footer>
        </div>
    </div>

    <script>
        const COLORS = [
            '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6',
            '#EC4899', '#14B8A6', '#F97316', '#6366F1', '#84CC16',
            '#06B6D4', '#D946EF', '#F43F5E', '#22D3EE', '#A3E635'
        ];

        const CSV_DATA_2025 =  `subcommittee,country,first_author_count,first_author_share(%),last_author_count,last_author_share(%)
(Unknown),Canada,0,0.0,1,3.85
(Unknown),China,9,34.62,8,30.77
(Unknown),Finland,0,0.0,1,3.85
(Unknown),France,1,3.85,1,3.85
(Unknown),Germany,1,3.85,0,0.0
(Unknown),Japan,3,11.54,4,15.38
(Unknown),Korea,5,19.23,3,11.54
(Unknown),Netherlands,0,0.0,1,3.85
(Unknown),Switzerland,1,3.85,0,0.0
(Unknown),United Arab Emirates,0,0.0,2,7.69
(Unknown),United States,6,23.08,5,19.23
AI-Accelerators,China,2,20.0,2,20.0
AI-Accelerators,"Hong Kong, China",1,10.0,1,10.0
AI-Accelerators,Korea,4,40.0,5,50.0
AI-Accelerators,Taiwan,1,10.0,1,10.0
AI-Accelerators,United States,2,20.0,1,10.0
Analog Techniques,China,7,36.11,5,25.0
Analog Techniques,France,1,4.165,2,12.5
Analog Techniques,Germany,2,20.835,2,20.835
Analog Techniques,"Hong Kong, China",1,16.67,0,0.0
Analog Techniques,Ireland,1,8.33,0,0.0
Analog Techniques,Japan,1,8.33,0,0.0
Analog Techniques,"Macau, China",2,14.165,0,0.0
Analog Techniques,Netherlands,3,18.89,2,15.0
Analog Techniques,Portugal,0,0.0,2,14.165
Analog Techniques,Switzerland,1,8.33,1,8.33
Analog Techniques,Taiwan,2,13.89,4,19.44666666666667
Analog Techniques,United Kingdom,0,0.0,1,8.33
Analog Techniques,United States,4,16.665,5,25.0
Data Converters,Belgium,1,12.5,1,12.5
Data Converters,China,10,62.5,10,62.5
Data Converters,Ireland,0,0.0,1,12.5
Data Converters,"Macau, China",3,37.5,0,0.0
Data Converters,Portugal,0,0.0,3,37.5
Data Converters,Taiwan,1,12.5,0,0.0
Data Converters,United States,1,12.5,1,12.5
Digital,China,4,24.305,4,24.305
Digital,Germany,1,5.555,1,6.25
Digital,India,0,0.0,1,11.11
Digital,Korea,5,29.86,2,11.11
Digital,Taiwan,1,11.11,0,0.0
Digital,United Kingdom,1,11.11,1,11.11
Digital,United States,5,29.165,8,47.22
Frequency Synthesizers,Austria,1,16.67,1,16.67
Frequency Synthesizers,China,5,26.515,5,26.515
Frequency Synthesizers,"Hong Kong, China",1,16.67,1,16.67
Frequency Synthesizers,Ireland,1,9.09,0,0.0
Frequency Synthesizers,Italy,1,16.67,0,0.0
Frequency Synthesizers,Japan,1,9.09,1,9.09
Frequency Synthesizers,Korea,2,12.88,2,12.88
Frequency Synthesizers,"Macau, China",2,18.18,0,0.0
Frequency Synthesizers,Portugal,0,0.0,2,18.18
Frequency Synthesizers,Switzerland,1,4.545,2,12.88
Frequency Synthesizers,Taiwan,1,9.09,1,9.09
Frequency Synthesizers,United Kingdom,0,0.0,1,9.09
Frequency Synthesizers,United States,1,16.67,1,16.67
Hardware Security,China,1,16.67,2,33.33
Hardware Security,Germany,1,16.67,1,16.67
Hardware Security,Korea,1,16.67,1,16.67
Hardware Security,Singapore,1,16.67,0,0.0
Hardware Security,Taiwan,1,16.67,1,16.67
Hardware Security,United States,1,16.67,1,16.67
Imagers and Displays,Canada,2,28.57,1,14.29
Imagers and Displays,China,3,25.0,4,35.0
Imagers and Displays,Japan,1,10.0,1,10.0
Imagers and Displays,Korea,11,40.596666666666664,10,35.833333333333336
Imagers and Displays,Netherlands,2,13.395,1,6.25
Imagers and Displays,Switzerland,1,14.29,0,0.0
Imagers and Displays,Taiwan,1,14.29,2,28.57
Imagers and Displays,United Kingdom,1,12.5,1,12.5
Imagers and Displays,United States,5,20.596666666666668,8,34.88
Invited Industry,Denmark,0,0.0,1,25.0
Invited Industry,Germany,1,25.0,1,25.0
Invited Industry,Korea,3,37.5,3,37.5
Invited Industry,United States,8,66.66666666666667,7,58.333333333333336
Memory,China,5,71.43,4,57.14
Memory,India,0,0.0,1,20.0
Memory,Japan,0,0.0,1,20.0
Memory,Korea,5,100.0,4,80.0
Memory,"Macau, China",0,0.0,1,14.29
Memory,Singapore,0,0.0,1,20.0
Memory,Taiwan,4,34.285,2,17.145
Memory,United States,3,20.0,3,18.096666666666668
Power,China,8,22.4725,12,40.025
Power,France,0,0.0,1,11.11
Power,Germany,0,0.0,1,11.11
Power,Korea,6,25.50333333333333,6,25.50333333333333
Power,"Macau, China",7,23.295,0,0.0
Power,Netherlands,2,50.0,0,0.0
Power,Portugal,0,0.0,3,17.593333333333334
Power,Taiwan,2,33.33,2,33.33
Power,United States,5,19.023333333333333,5,18.349999999999998
Processors,China,2,20.0,2,20.0
Processors,India,2,20.0,1,10.0
Processors,Korea,1,10.0,1,10.0
Processors,Taiwan,3,30.0,2,20.0
Processors,United States,2,20.0,4,40.0
TD,China,2,20.0,2,20.0
TD,Italy,1,20.0,1,20.0
TD,Jordan,1,20.0,0,0.0
TD,Switzerland,1,20.0,1,20.0
TD,United States,5,50.0,6,60.0
Wireless,China,8,52.725,7,42.725
Wireless,Germany,0,0.0,1,9.09
Wireless,Japan,1,9.09,1,9.09
Wireless,Korea,2,14.545,2,14.545
Wireless,Netherlands,1,9.09,0,0.0
Wireless,Singapore,0,0.0,1,20.0
Wireless,Switzerland,2,14.545,2,14.545
Wireless,United States,2,18.18,2,18.18
Wireline,Canada,0,0.0,1,10.0
Wireline,China,9,47.22,8,41.665
Wireline,"Hong Kong, China",0,0.0,1,11.11
Wireline,Italy,0,0.0,1,11.11
Wireline,Korea,1,10.0,0,0.0
Wireline,Switzerland,0,0.0,1,10.0
Wireline,Taiwan,3,15.555,2,10.0
Wireline,United States,6,32.22,5,27.22`;

        const CSV_DATA_2026 = `subcommittee,country,first_author_count,first_author_share(%),last_author_count,last_author_share(%)
AI Accelerators,China,4,44.44444444444444,4,44.44444444444444
AI Accelerators,Korea,4,44.44444444444444,4,44.44444444444444
AI Accelerators,United States,1,11.11111111111111,1,11.11111111111111
Analog Techniques & Ampliﬁers,China,5,83.33333333333334,5,83.33333333333334
Analog Techniques & Ampliﬁers,The Netherlands,1,16.666666666666664,1,16.666666666666664
Biochemical Sensors for Life Sciences and Agriculture,Belgium,1,16.666666666666664,1,16.666666666666664
Biochemical Sensors for Life Sciences and Agriculture,China,1,16.666666666666664,1,16.666666666666664
Biochemical Sensors for Life Sciences and Agriculture,France,1,16.666666666666664,1,16.666666666666664
Biochemical Sensors for Life Sciences and Agriculture,Japan,1,16.666666666666664,1,16.666666666666664
Biochemical Sensors for Life Sciences and Agriculture,Korea,1,16.666666666666664,1,16.666666666666664
Biochemical Sensors for Life Sciences and Agriculture,United States,1,16.666666666666664,1,16.666666666666664
Circuits for AI and AI for Circuits,China,3,60.0,3,60.0
Circuits for AI and AI for Circuits,Japan,1,20.0,1,20.0
Circuits for AI and AI for Circuits,United States,1,20.0,1,20.0
Data Converters for Wireline and Low Power IoT,China,2,50.0,2,50.0
Data Converters for Wireline and Low Power IoT,Singapore,1,25.0,1,25.0
Data Converters for Wireline and Low Power IoT,United States,1,25.0,1,25.0
DRAM, SRAM, and Non-Volatile Memories,Belgium,1,6.25,1,6.25
DRAM, SRAM, and Non-Volatile Memories,China,6,37.5,6,37.5
DRAM, SRAM, and Non-Volatile Memories,Germany,1,6.25,1,6.25
DRAM, SRAM, and Non-Volatile Memories,India,1,6.25,1,6.25
DRAM, SRAM, and Non-Volatile Memories,Italy,1,6.25,1,6.25
DRAM, SRAM, and Non-Volatile Memories,Japan,1,6.25,1,6.25
DRAM, SRAM, and Non-Volatile Memories,Korea,4,25.0,4,25.0
DRAM, SRAM, and Non-Volatile Memories,Singapore,1,6.25,1,6.25
DRAM, SRAM, and Non-Volatile Memories,United States,1,6.25,1,6.25
Energy-Efﬁcient and Flexible Architectures for AI,China,1,20.0,1,20.0
Energy-Efﬁcient and Flexible Architectures for AI,Japan,1,20.0,1,20.0
Energy-Efﬁcient and Flexible Architectures for AI,Korea,3,60.0,3,60.0
Energy-Efﬁcient DC-DC Converters,China,4,44.44444444444444,4,44.44444444444444
Energy-Efﬁcient DC-DC Converters,Korea,2,22.22222222222222,2,22.22222222222222
Energy-Efﬁcient DC-DC Converters,The Netherlands,2,22.22222222222222,2,22.22222222222222
Energy-Efﬁcient DC-DC Converters,United States,1,11.11111111111111,1,11.11111111111111
Energy-Efﬁcient Neural Interface and Biomedical Implants,China,1,10.0,1,10.0
Energy-Efﬁcient Neural Interface and Biomedical Implants,Germany,1,10.0,1,10.0
Energy-Efﬁcient Neural Interface and Biomedical Implants,Japan,1,10.0,1,10.0
Energy-Efﬁcient Neural Interface and Biomedical Implants,Korea,3,30.0,3,30.0
Energy-Efﬁcient Neural Interface and Biomedical Implants,Switzerland,1,10.0,1,10.0
Energy-Efﬁcient Neural Interface and Biomedical Implants,United Kingdom,1,10.0,1,10.0
Energy-Efﬁcient Neural Interface and Biomedical Implants,United States,2,20.0,2,20.0
Frequency Synthesizers,China,5,50.0,5,50.0
Frequency Synthesizers,France,1,10.0,1,10.0
Frequency Synthesizers,Japan,1,10.0,1,10.0
Frequency Synthesizers,Korea,2,20.0,2,20.0
Frequency Synthesizers,Switzerland,1,10.0,1,10.0
Invited Industry,China,1,12.5,1,12.5
Invited Industry,Germany,1,12.5,1,12.5
Invited Industry,India,1,12.5,1,12.5
Invited Industry,Japan,1,12.5,1,12.5
Invited Industry,Korea,1,12.5,1,12.5
Invited Industry,United States,2,25.0,2,25.0
Low Power Wireless Transceivers for Localization and Communications,China,1,20.0,1,20.0
Low Power Wireless Transceivers for Localization and Communications,France,1,20.0,1,20.0
Low Power Wireless Transceivers for Localization and Communications,Japan,1,20.0,1,20.0
Low Power Wireless Transceivers for Localization and Communications,Korea,1,20.0,1,20.0
Low Power Wireless Transceivers for Localization and Communications,United States,1,20.0,1,20.0
Mixed-Signal Circuits for Image Sensors,China,2,40.0,2,40.0
Mixed-Signal Circuits for Image Sensors,Japan,2,40.0,2,40.0
Mixed-Signal Circuits for Image Sensors,United States,1,20.0,1,20.0
Next-Generation Optical Transceivers,China,1,33.33333333333333,1,33.33333333333333
Next-Generation Optical Transceivers,Germany,1,33.33333333333333,1,33.33333333333333
Next-Generation Optical Transceivers,United States,1,33.33333333333333,1,33.33333333333333
Pipeline and Ultra-High-Speed Data Converters,China,3,75.0,3,75.0
Pipeline and Ultra-High-Speed Data Converters,Japan,1,25.0,1,25.0
Plenary - Invited Papers,Switzerland,1,33.33333333333333,1,33.33333333333333
Plenary - Invited Papers,Taiwan,1,33.33333333333333,1,33.33333333333333
Plenary - Invited Papers,United States,1,33.33333333333333,1,33.33333333333333
Power Conversion for Mobile and High-Performance Processors,China,4,66.66666666666666,4,66.66666666666666
Power Conversion for Mobile and High-Performance Processors,Germany,1,16.666666666666664,1,16.666666666666664
Power Conversion for Mobile and High-Performance Processors,Switzerland,1,16.666666666666664,1,16.666666666666664
Power Electronics Converters for Wide Supply Range and High Power,China,2,33.33333333333333,2,33.33333333333333
Power Electronics Converters for Wide Supply Range and High Power,Korea,2,33.33333333333333,2,33.33333333333333
Power Electronics Converters for Wide Supply Range and High Power,The Netherlands,1,16.666666666666664,1,16.666666666666664
Power Electronics Converters for Wide Supply Range and High Power,United States,1,16.666666666666664,1,16.666666666666664
Processors,China,3,42.857142857142854,3,42.857142857142854
Processors,Japan,1,14.285714285714285,1,14.285714285714285
Processors,Korea,1,14.285714285714285,1,14.285714285714285
Processors,United States,2,28.57142857142857,2,28.57142857142857
RF Transceiver Subsystems from cm-Wave to THz,China,2,33.33333333333333,2,33.33333333333333
RF Transceiver Subsystems from cm-Wave to THz,Japan,1,16.666666666666664,1,16.666666666666664
RF Transceiver Subsystems from cm-Wave to THz,Korea,1,16.666666666666664,1,16.666666666666664
RF Transceiver Subsystems from cm-Wave to THz,Switzerland,1,16.666666666666664,1,16.666666666666664
RF Transceiver Subsystems from cm-Wave to THz,United States,1,16.666666666666664,1,16.666666666666664
Sensor Interfaces,China,3,60.0,3,60.0
Sensor Interfaces,Japan,1,20.0,1,20.0
Sensor Interfaces,United States,1,20.0,1,20.0
Sub-THz and mm-Wave Phased Arrays and Beamformers,China,3,75.0,3,75.0
Sub-THz and mm-Wave Phased Arrays and Beamformers,Korea,1,25.0,1,25.0
Technology and Circuits for Domain-Speciﬁc Accelerators,China,3,75.0,3,75.0
Technology and Circuits for Domain-Speciﬁc Accelerators,Japan,1,25.0,1,25.0
Time-Varying Circuit Techniques from RF to mm-Wave,China,2,66.66666666666666,2,66.66666666666666
Time-Varying Circuit Techniques from RF to mm-Wave,Germany,1,33.33333333333333,1,33.33333333333333
Towards Better Performances and Integration for Outphasing PAs,China,2,66.66666666666666,2,66.66666666666666
Towards Better Performances and Integration for Outphasing PAs,Japan,1,33.33333333333333,1,33.33333333333333
Unusual Interconnects and Other Uses for Light,China,1,33.33333333333333,1,33.33333333333333
Unusual Interconnects and Other Uses for Light,Ireland,1,33.33333333333333,1,33.33333333333333
Unusual Interconnects and Other Uses for Light,The Netherlands,1,33.33333333333333,1,33.33333333333333
Wearable and Wireless Biomedical Systems,China,1,20.0,1,20.0
Wearable and Wireless Biomedical Systems,Germany,1,20.0,1,20.0
Wearable and Wireless Biomedical Systems,Japan,1,20.0,1,20.0
Wearable and Wireless Biomedical Systems,Korea,1,20.0,1,20.0
Wearable and Wireless Biomedical Systems,United States,1,20.0,1,20.0
Wireless Power,China,1,20.0,1,20.0
Wireless Power,France,1,20.0,1,20.0
Wireless Power,Japan,1,20.0,1,20.0
Wireless Power,Korea,1,20.0,1,20.0
Wireless Power,United States,1,20.0,1,20.0`;

        // Parse CSV into data structure
        function processData(csvText) {
            const lines = csvText.trim().split('\n');
            const subcommitteeMap = {};
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                const match = line.match(/^([^,]+),(.+)$/);
                if (!match) continue;
                
                const subcommittee = match[1];
                const rest = match[2];
                
                let country, values;
                if (rest.startsWith('"')) {
                    const endQuote = rest.indexOf('"', 1);
                    country = rest.substring(1, endQuote);
                    values = rest.substring(endQuote + 2).split(',');
                } else {
                    const parts = rest.split(',');
                    country = parts[0];
                    values = parts.slice(1);
                }
                
                if (!subcommitteeMap[subcommittee]) {
                    subcommitteeMap[subcommittee] = [];
                }
                
                subcommitteeMap[subcommittee].push({
                    country: country,
                    firstAuthorCount: parseInt(values[0]) || 0,
                    firstAuthorShare: parseFloat(values[1]) || 0,
                    lastAuthorCount: parseInt(values[2]) || 0,
                    lastAuthorShare: parseFloat(values[3]) || 0
                });
            }
            
            const subcommittees = Object.entries(subcommitteeMap).map(([name, countries]) => ({
                name,
                countries
            }));
            
            // Compute overall
            const countryMap = {};
            subcommittees.forEach(sub => {
                sub.countries.forEach(row => {
                    if (!countryMap[row.country]) {
                        countryMap[row.country] = {
                            country: row.country,
                            firstAuthorCount: 0,
                            lastAuthorCount: 0
                        };
                    }
                    countryMap[row.country].firstAuthorCount += row.firstAuthorCount;
                    countryMap[row.country].lastAuthorCount += row.lastAuthorCount;
                });
            });
            
            // Calculate totals once (not inside the map loop)
            const countries = Object.values(countryMap);
            const totalFirst = countries.reduce((sum, x) => sum + x.firstAuthorCount, 0);
            const totalLast = countries.reduce((sum, x) => sum + x.lastAuthorCount, 0);

            const overall = countries.map(c => ({
                ...c,
                firstAuthorShare: totalFirst > 0 ? (c.firstAuthorCount / totalFirst * 100) : 0,
                lastAuthorShare: totalLast > 0 ? (c.lastAuthorCount / totalLast * 100) : 0
            })).filter(c => c.firstAuthorCount > 0 || c.lastAuthorCount > 0);
            
            return { overall, subcommittees };
        }

        const yearData = {
            "2025": processData(CSV_DATA_2025),
            "2026": processData(CSV_DATA_2026)
        };
        let currentYear = "2025";
        let data = yearData[currentYear];
        let chart = null;

        // ドロップダウンを初期化
        const datasetSelect = document.getElementById('dataset-select');
        const viewSelect = document.getElementById('view-select');

        function populateViewOptions() {
            viewSelect.innerHTML = '<option value="overall">Overall</option>';
            data.subcommittees.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.name;
                option.textContent = sub.name;
                viewSelect.appendChild(option);
            });
        }

        populateViewOptions();

        // 更新関数
        function updateView() {
            const selectedView = viewSelect.value;
            const authorType = document.getElementById('author-select').value;
            
            let currentData;
            if (selectedView === 'overall') {
                currentData = data.overall;
                document.getElementById('subcommittee-name').textContent = '';
            } else {
                const sub = data.subcommittees.find(s => s.name === selectedView);
                currentData = sub ? sub.countries : [];
                document.getElementById('subcommittee-name').textContent = '- ' + selectedView;
            }
            
            const countField = authorType === 'first' ? 'firstAuthorCount' : 'lastAuthorCount';
            
            // Recalculate shares from counts with proper rounding to sum to 100%
            const totalCount = currentData.reduce((sum, d) => sum + d[countField], 0);
            const filteredData = currentData.filter(d => d[countField] > 0);

            // Calculate raw shares and round to 2 decimal places
            let chartData = filteredData.map(d => ({
                ...d,
                calculatedShare: totalCount > 0 ? Math.round(d[countField] / totalCount * 10000) / 100 : 0
            })).sort((a, b) => b.calculatedShare - a.calculatedShare);

            // Adjust the smallest share so total equals exactly 100%
            if (chartData.length > 0) {
                const currentSum = chartData.reduce((sum, d) => sum + d.calculatedShare, 0);
                const diff = Math.round((100 - currentSum) * 100) / 100;
                if (diff !== 0) {
                    // Add the difference to the last (smallest) item and re-round to avoid floating point issues
                    chartData[chartData.length - 1].calculatedShare =
                        Math.round((chartData[chartData.length - 1].calculatedShare + diff) * 100) / 100;
                }
            }
            
            // Update chart
            if (chart) {
                chart.destroy();
            }
            
            const ctx = document.getElementById('pieChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: chartData.map(d => d.country),
                    datasets: [{
                        data: chartData.map(d => d.calculatedShare),
                        backgroundColor: COLORS
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: label + ': ' + data.datasets[0].data[i].toFixed(2) + '%',
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    }));
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            // Update table
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            chartData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-100 hover:bg-slate-50';
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm text-slate-600">${index + 1}</td>
                    <td class="px-4 py-3 text-sm font-medium text-slate-800">${row.country}</td>
                    <td class="px-4 py-3 text-sm text-slate-600 text-right">${row[countField]}</td>
                    <td class="px-4 py-3 text-sm text-slate-600 text-right">${row.calculatedShare.toFixed(2)}%</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // Event listeners
        datasetSelect.addEventListener('change', () => {
            currentYear = datasetSelect.value;
            data = yearData[currentYear];
            populateViewOptions();
            updateView();
        });

        viewSelect.addEventListener('change', updateView);
        document.getElementById('author-select').addEventListener('change', updateView);

        // Initial render
        updateView();
    </script>
</body>
</html>
