<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ISSCC 2025 Country Share Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b1220; --card:#151c2f; --muted:#8aa0c9; --accent:#5aa6ff; --grid:#22304f; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:white;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
    header{padding:24px 20px;border-bottom:1px solid var(--grid);position:sticky;top:0;background:linear-gradient(180deg,var(--bg) 0%,rgba(11,18,32,.9) 100%);backdrop-filter:saturate(1.2) blur(6px)}
    h1{font-size:20px;margin:0}
    .container{max-width:1100px;margin:24px auto;padding:0 20px}
    .controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px}
    select,button{appearance:none;background:var(--card);color:white;border:1px solid var(--grid);border-radius:12px;padding:10px 12px;font:inherit}
    button{cursor:pointer}
    .cards{display:grid;grid-template-columns:2fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--grid);border-radius:16px;padding:16px}
    .card h2{font-size:16px;margin:0 0 8px 0}
    .muted{color:var(--muted)}
    .legend{display:flex;gap:12px;font-size:12px;margin:6px 0 12px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#121a2b;border:1px solid var(--grid)}
    .dot{width:10px;height:10px;border-radius:50%}
    .chart{height:460px}
    svg{width:100%;height:100%}
    table{width:100%;border-collapse:collapse}
    th,td{font-size:12px;padding:8px;border-bottom:1px solid var(--grid)}
    th{text-align:left;color:var(--muted)}
    .footer{margin-top:24px;color:var(--muted);font-size:12px}
    .badge{background:#12233d;color:#9ec3ff;border:1px solid var(--grid);padding:2px 6px;border-radius:6px;margin-left:6px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
</head>
<body>
  <header>
    <h1>ISSCC 2025 — Country Share Dashboard <span class="badge">Static Web</span></h1>
    <div class="muted" style="margin-top:6px">Visualize country shares overall and by subcommittee (session theme). Upload CSVs to the same folder.</div>
  </header>

  <div class="container">
    <div class="controls">
      <div>
        <label class="muted" for="scope">Scope</label>
        <select id="scope">
          <option value="overall">Overall</option>
          <option value="subcommittee">By Subcommittee</option>
        </select>
      </div>
      <div>
        <label class="muted" for="metric">Metric</label>
        <select id="metric">
          <option value="first">First Author</option>
          <option value="last">Last Author</option>
        </select>
      </div>
      <div id="subcomWrap" style="display:none">
        <label class="muted" for="subcom">Subcommittee (session theme)</label>
        <select id="subcom"></select>
      </div>
    </div>

    <div class="cards">
      <div class="card">
        <h2>Country Share Bar Chart</h2>
        <div class="legend">
          <div class="pill"><span class="dot" style="background:var(--accent)"></span> Share (%)</div>
        </div>
        <div class="chart" id="chart"></div>
      </div>
      <div class="card">
        <h2>Top Countries</h2>
        <table id="tbl"><thead><tr><th>Country</th><th>Count</th><th>Share (%)</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Data Preview</h2>
      <div class="muted" style="margin-bottom:8px">This mirrors the filtered view (first 25 rows).</div>
      <table id="preview"><thead></thead><tbody></tbody></table>
    </div>

    <div class="footer">
      <b>How to use on GitHub Pages</b>:
      <ol>
        <li>Put this <code>index.html</code> and the three CSVs in the repo root:</li>
        <ul>
          <li><code>overall_country_share.csv</code></li>
          <li><code>subcommittee_country_share.csv</code></li>
          <li><code>papers_raw.csv</code> (optional for audit)</li>
        </ul>
        <li>Settings → Pages → Source: <i>Deploy from a branch</i> → select <i>main</i> and <i>/ (root)</i>.</li>
        <li>Open the Pages URL to view the dashboard.</li>
      </ol>
    </div>
  </div>

<script>
(async function(){
  const overallURL = 'overall_country_share.csv';
  const subcomURL  = 'subcommittee_country_share.csv';
  const papersURL  = 'papers_raw.csv';

  const overall = await d3.csv(overallURL, d3.autoType).catch(()=>[]);
  const subcom  = await d3.csv(subcomURL, d3.autoType).catch(()=>[]);
  const papers  = await d3.csv(papersURL, d3.autoType).catch(()=>[]);

  // ✅ デバッグ用にグローバルに公開
  window.debugData = { overall, subcom, papers };
  console.log('📊 Data loaded:', {
    overall: overall.length,
    subcom: subcom.length,
    papers: papers.length
  });
  console.log('🔍 Subcom first row:', subcom[0]);
  console.log('🔍 Subcom columns:', Object.keys(subcom[0] || {}));

  const els = {
    scope: document.getElementById('scope'),
    metric: document.getElementById('metric'),
    subcomWrap: document.getElementById('subcomWrap'),
    subcom: document.getElementById('subcom'),
    chart: document.getElementById('chart'),
    tbl: document.getElementById('tbl').querySelector('tbody'),
    previewHead: document.getElementById('preview').querySelector('thead'),
    previewBody: document.getElementById('preview').querySelector('tbody')
  };

  // populate subcommittee list
  const subList = Array.from(new Set(subcom.map(d=>d.subcommittee))).sort();
  els.subcom.innerHTML = subList.map(s=>`<option>${s}</option>`).join('');

  function getCurrentData(){
    const metric = els.metric.value; // first or last
    const scope = els.scope.value;
    if(scope==='overall'){
      const countKey = metric==='first' ? 'first_author_count' : 'last_author_count';
      const shareKey = metric==='first' ? 'first_author_share(%)' : 'last_author_share(%)';
      return overall.map(d=>({country:d.country, count:+d[countKey]||0, share:+d[shareKey]||0})).sort((a,b)=>b.count-a.count);
    } else {
      const sel = els.subcom.value;
      const countKey = metric==='first' ? 'first_author_count' : 'last_author_count';
      const shareKey = metric==='first' ? 'first_author_share(%)' : 'last_author_share(%)';
      return subcom.filter(d=>d.subcommittee===sel).map(d=>({country:d.country, count:+d[countKey]||0, share:+d[shareKey]||0})).sort((a,b)=>b.count-a.count);
    }
  }

  function renderChart(){
    const data = getCurrentData().slice(0,20); // top 20
    els.chart.innerHTML = '';
    const margin = {top:10,right:10,bottom:40,left:130};
    const w = els.chart.clientWidth - margin.left - margin.right;
    const h = els.chart.clientHeight - margin.top - margin.bottom;

    const svg = d3.select(els.chart).append('svg')
      .attr('viewBox', `0 0 ${w+margin.left+margin.right} ${h+margin.top+margin.bottom}`)
      .append('g').attr('transform',`translate(${margin.left},${margin.top})`);

    const x = d3.scaleLinear().domain([0, d3.max(data, d=>d.share)||1]).range([0,w]);
    const y = d3.scaleBand().domain(data.map(d=>d.country)).range([0,h]).padding(0.12);

    svg.append('g').selectAll('rect').data(data).join('rect')
      .attr('x',0).attr('y',d=>y(d.country)).attr('width',d=>x(d.share)).attr('height',y.bandwidth())
      .attr('fill','var(--accent)');

    svg.append('g').call(d3.axisLeft(y).tickSize(0)).selectAll('text').style('fill','white').style('font-size','12px');
    svg.append('g').attr('transform',`translate(0,${h})`).call(d3.axisBottom(x).ticks(5).tickFormat(d=>d+"%"))
      .selectAll('text').style('fill','var(--muted)').style('font-size','12px');

    // labels
    svg.selectAll('.lbl').data(data).join('text').attr('class','lbl')
      .attr('x', d=>x(d.share)+6).attr('y', d=>y(d.country)+y.bandwidth()/2+4)
      .text(d=>`${d.share.toFixed(1)}%`).style('font-size','11px').style('fill','#cfe2ff');
  }

  function renderTable(){
    const data = getCurrentData();
    els.tbl.innerHTML = data.slice(0,20).map(d=>`<tr><td>${d.country}</td><td>${d.count}</td><td>${d.share.toFixed(2)}</td></tr>`).join('');
  }

  function renderPreview(){
    // Show raw papers for context (first 25)
    const cols = Object.keys(papers[0]||{});
    els.previewHead.innerHTML = `<tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr>`;
    const rows = papers.slice(0,25).map(r=>`<tr>${cols.map(c=>`<td>${r[c]??''}</td>`).join('')}</tr>`).join('');
    els.previewBody.innerHTML = rows;
  }

  function onScope(){ els.subcomWrap.style.display = els.scope.value==='subcommittee' ? 'block' : 'none'; renderAll(); }
  function renderAll(){ renderChart(); renderTable(); renderPreview(); }

  els.scope.addEventListener('change', onScope);
  els.metric.addEventListener('change', renderAll);
  els.subcom.addEventListener('change', renderAll);

  onScope();
})();
</script>
</body>
</html>
